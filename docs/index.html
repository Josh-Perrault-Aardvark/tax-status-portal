<script>
  function getRawFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get("tickets");
    if (!encoded) return "";
    try {
      return decodeURIComponent(encoded);
    } catch {
      return encoded;
    }
  }

  function mapClientStatus(raw) {
    if (!raw) return "";

    const table = {
      "In Progress": "In Progress",
      "Preparation in Progress": "In Progress",
      "Preparation Completed": "Ready for Review",
      "Review in Progress": "In Review",
      "Review Completed": "Reviewed",
      "Awaiting Client Documents": "Waiting on You",
      "Tax Return Filed with IRS": "Filed with IRS",
      "Tax Return Accepted": "Accepted by IRS",
      "Extension Filed with IRS": "Extension Filed",
      "Extension Accepted": "Extension Accepted",
      "Tax Return Complete": "Complete",
      "Review SharePoint Folder": "Review SP",
      "Documents Received": "Documents Received",
    };

    return table[raw] || raw;
  }

  // -----------------------------
  // üî• Correct ‚ÄúDecember 4th, 2025‚Äù formatter
  // -----------------------------
  function formatDate(iso) {
    if (!iso) return "";

    const ms = Number(iso);
    if (!ms || ms < 0) return iso;

    const d = new Date(ms);
    if (isNaN(d.getTime())) return iso;

    const day = d.getDate();

    // Ordinal suffix logic
    const suffix =
      day >= 11 && day <= 13
        ? "th"
        : ["st", "nd", "rd"][(day % 10) - 1] || "th";

    const month = d.toLocaleString("en-US", { month: "long" });
    const year = d.getFullYear();

    return `${month} ${day}${suffix}, ${year}`;
  }

  function parseRows(rawString) {
    if (!rawString) return [];
    let rows;
    try {
      rows = JSON.parse(rawString);
    } catch (e) {
      console.error("Bad JSON for tax return status", e);
      showError("Failed to parse tax return status data.");
      return [];
    }

    return rows
      .map(function (r) {
        return {
          clientName: r.client_name || "",
          taxYear: String(r.tax_year || ""),
          taxReturnType: r.tax_return_type || r.type || "",
          status: mapClientStatus(r.status_label || r.status || ""),
          lastUpdatedIso: r.updated_iso || r.last_updated || "",
        };
      })
      .sort(function (a, b) {
        return Number(b.taxYear) - Number(a.taxYear);
      });
  }

  function showError(message) {
    var el = document.getElementById("error");
    el.textContent = message;
    el.style.display = "block";
  }

  function renderTable(rows) {
    var tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    if (!rows.length) {
      var tr = document.createElement("tr");
      var td = document.createElement("td");
      td.colSpan = 5;
      td.className = "empty";
      td.textContent = "No tax return status data available.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(function (row, idx) {
      var tr = document.createElement("tr");

      var tdClient = document.createElement("td");
      tdClient.className = "client";
      tdClient.textContent = row.clientName;
      tr.appendChild(tdClient);

      var tdYear = document.createElement("td");
      tdYear.textContent = row.taxYear;
      tr.appendChild(tdYear);

      var tdType = document.createElement("td");
      tdType.textContent = row.taxReturnType;
      tr.appendChild(tdType);

      var tdStatus = document.createElement("td");
      tdStatus.textContent = row.status;
      tr.appendChild(tdStatus);

      var tdUpdated = document.createElement("td");
      tdUpdated.textContent = formatDate(row.lastUpdatedIso);
      tr.appendChild(tdUpdated);

      tbody.appendChild(tr);
    });
  }

  (function init() {
    try {
      var raw = getRawFromQuery();
      var rows = parseRows(raw);
      renderTable(rows);
    } catch (e) {
      console.error(e);
      showError("Failed to load tax return status data.");
    }
  })();
</script>
